{% extends "dashboard/base.html" %}
{% load i18n %}
{% load store_tags %}

{% block title-page %}{% trans "Virtual machines" %}{% endblock %}

{% block content %}

<div class="row">
  <div class="col-md-12">
    <div class="list-group" id="store-list-list">
      <a href="?directory={{ up_url }}" class="list-group-item store-list-item" data-item-type="D">
        <i class="icon-reply store-list-item-icon"></i>
        ..
        <div class="pull-right">
          {{ current }}
        </div>
      </a>
    {% for f in root %}
    <a class="list-group-item store-list-item" data-item-type="{{ f.TYPE }}"
      href="{% if f.TYPE == "D" %}?directory={{ f.path }}{% else %}
      {# url "dashboard.views.store-download" #}?path={{ f.path }}{% endif %}">
      <div class="store-list-item-icon">
      <i class="
        icon-{% if f.TYPE == "D" %}folder-open-alt{% else %}file-alt{% endif %}"
        ></i>
    </div>
      {{ f.NAME }}
      <div class="store-list-item-size">
        {{ f.human_readable_size }}
      </div>
      <div class="clearfix"></div>
    </a>
      <div class="store-list-file-infos" style="position: relative;">
        <a href="{% url "dashboard.views.store-download" %}?path={{ f.path }}" 
          class="btn btn-primary" style="position: absolute; right: 15px; top: 32px;">
          <i class="icon-download"></i>
          Download
        </a>
        <dl class="dl-horizontal" style="margin: 0; padding: 0;">
          <dt>Filename</dt>
          <dd>{{ f.NAME }}</dd>

          <dt>Size</dt>
          <dd>{{ f.human_readable_size }}</dd>

          <dt>Latest modification</dt>
          <dd>{{ f.human_readable_date }}</dd>
        </dl>
      </div>
      {% empty %}
      <a class="list-group-item">
        {% trans "This folder is empty." %}
      </a>
    {% endfor %}
    <div class="list-group-item" style="height: 50px;">
      Upload file to this folder
      <form action="" data-action="{% url "dashboard.views.store-upload" %}" 
        method="POST" enctype="multipart/form-data" class="pull-right"
        id="store-upload-form">
        {% csrf_token %}
        <input type="hidden" name="current_dir" value="{{ current }}"/>
        <div class="input-group" style="max-width: 400px;">
          <span class="input-group-btn" id="store-upload-browse">
            <span class="btn btn-primary btn-sm">
              {% trans "Browse..." %}
            </span>     
          </span>
          <input type="text" class="input-sm form-control" 
           id="store-upload-filename"/>
          <span class="input-group-btn">
            <input type="submit" class="btn btn-primary btn-sm"
            value="{% trans "Upload" %}"/>
          </span>
        </div>
        <input id="store-upload-file" name="data" type="file" style="display:none" multiple>
 
<script type="text/javascript">
  $('#store-upload-browse').click(function() {
    $('#store-upload-form input[type="file"]').click();
  });
  
  $("#store-upload-file").change(function() {
    var input = $(this);
    var numFiles = input.get(0).files ? input.get(0).files.length : 1;
    var label = input.val().replace(/\\/g, '/').replace(/.*\//, '');
    input.trigger('fileselect', [numFiles, label]);
  });

  $("#store-upload-file").on("fileselect", function(event, numFiles, label)  {
        var input = $("#store-upload-filename");
        var log = numFiles > 1 ? numFiles + ' files selected' : label;
        
        if( input.length ) {
            input.val(log);
        }
  });

</script>
      </form>
    </div>
    </div>
  </div>
</div>

<style>
  #store-list-list {
    list-style: none;
  }

  .store-list-item {
    cursor: pointer;
  }

  .store-list-item:hover {
    background: rgba(0, 0, 0, 0.6);
  }

  .store-list-item-icon {
    width: 20px;
    text-align: center;
    display: inline-block;
    margin-right: 15px;
  }

  .store-list-item-size {
    width: 70px;
    text-align: right;
    float: right;
  }

  .store-list-file-infos {
    padding: 20px;
    display: none;
    border-left: 1px solid #ddd;
    border-right: 1px solid #ddd;
  }
</style>
<script>
$(function() {
  $(".store-list-item").click(function() {
    if($(this).data("item-type") == "D") return true;
    $(this).next(".store-list-file-infos").stop().slideToggle();
    return false;
  });

  /* less js way, but at least works, tho redirection is bad */
  $('form input[type="submit"]').click(function() {
    var current_dir = $("form").find('[name="current_dir"]').val();
    $.get($("form").data("action") + "?current_dir=" + current_dir, function(result) {
      $("form").get(0).setAttribute("action", result['url']);
      $("form").submit();
    });

    return false;
  });
  
  /* this does not work 
  $('form input[type="submit"]').click(function() {
    var current_dir = $("form").find('[name="current_dir"]').val();
    $.get($("form").data("action") + "?current_dir=" + current_dir, function(result) {
      $.ajax({
        method: "POST",
        url: result['url'],
        data: $("form").serialize(),
        success: function(re) {
          console.log(re);
        }
      });
    });

    return false;
  }); */
    
});
</script>

{% endblock %}

{% block extra_js %}
  <script src="{{ STATIC_URL}}dashboard/store.js"></script>
{% endblock %}
